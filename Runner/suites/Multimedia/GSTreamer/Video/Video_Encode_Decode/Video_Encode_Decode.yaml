metadata:
  name: gstreamer-video-encode-decode
  format: "Lava-Test Test Definition 1.0"
  description: >
    Video encode/decode validation using GStreamer (gst-launch-1.0) with V4L2 hardware-accelerated codecs
    on Qualcomm Linux platforms. Supports v4l2h264enc, v4l2h265enc, v4l2h264dec, v4l2h265dec, v4l2vp9dec.
    Uses videotestsrc to generate test patterns for H.264/H.265 (no external video files needed).
    For VP9 decode, downloads pre-encoded IVF clips from git repo, converts them to WebM container format,
    then decodes using v4l2vp9dec. Test skips if IVF to WebM conversion fails (no IVF fallback).
    Tests encoding at 480p and 4K resolutions, then decodes the encoded files.
  os:
    - linux
  scope:
    - functional
params:
  VIDEO_TEST_MODE: "all" # all|encode|decode
  VIDEO_CODECS: "h264,h265,vp9" # h264,h265,vp9
  VIDEO_RESOLUTIONS: "4k" # 480p,720p,1080p,4k
  VIDEO_DURATION: "30" # seconds
  VIDEO_FRAMERATE: "30" # fps
  VIDEO_STACK: "auto" # auto|upstream|downstream
  VIDEO_GST_DEBUG: "2" # 1-9
  VIDEO_CLIP_URL: "" # if set, overrides default GitHub URL
run:
  steps:
    - |
        REPO_PATH=$PWD
        cd Runner/suites/Multimedia/GSTreamer/Video/Video_Encode_Decode/ || exit 0

        CMD="./run.sh"

        # Use CLI args only (no exports). Script defaults apply if params are empty.
        if [ -n "${VIDEO_TEST_MODE}" ]; then
          CMD="${CMD} --mode ${VIDEO_TEST_MODE}"
        fi
        if [ -n "${VIDEO_CODECS}" ]; then
          CMD="${CMD} --codecs ${VIDEO_CODECS}"
        fi
        if [ -n "${VIDEO_RESOLUTIONS}" ]; then
          CMD="${CMD} --resolutions ${VIDEO_RESOLUTIONS}"
        fi
        if [ -n "${VIDEO_DURATION}" ]; then
          CMD="${CMD} --duration ${VIDEO_DURATION}"
        fi
        if [ -n "${VIDEO_FRAMERATE}" ]; then
          CMD="${CMD} --framerate ${VIDEO_FRAMERATE}"
        fi
        if [ -n "${VIDEO_STACK}" ]; then
          CMD="${CMD} --stack ${VIDEO_STACK}"
        fi
        if [ -n "${VIDEO_GST_DEBUG}" ]; then
          CMD="${CMD} --gst-debug ${VIDEO_GST_DEBUG}"
        fi
        if [ -n "${VIDEO_CLIP_URL}" ]; then
          CMD="${CMD} --clip-url ${VIDEO_CLIP_URL}"
        fi

        echo "[LAVA] Running: ${CMD}"
        sh -c "${CMD}" || true

        # Send result to LAVA (single command line to avoid YAML parsing issues)
        ${REPO_PATH}/Runner/utils/send-to-lava.sh Video_Encode_Decode.res
