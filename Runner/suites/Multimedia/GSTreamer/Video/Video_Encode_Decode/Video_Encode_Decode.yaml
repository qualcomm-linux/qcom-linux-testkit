metadata:
  name: gstreamer-video-encode-decode
  format: "Lava-Test Test Definition 1.0"
  description: >
    Video encode/decode validation using GStreamer (gst-launch-1.0) with V4L2 hardware-accelerated codecs
    on Qualcomm Linux platforms. Supports v4l2h264enc, v4l2h265enc, v4l2h264dec, v4l2h265dec, v4l2vp9dec.
    Uses videotestsrc to generate test patterns for H.264/H.265 (no external video files needed).
    For VP9 decode, downloads pre-encoded clips from git repo (requires network connectivity).
    Tests encoding at 480p and 4K resolutions, then decodes the encoded files.
  os:
    - linux
  scope:
    - functional

params:
  # Test mode: all (encode+decode), encode (only), decode (only)
  VIDEO_TEST_MODE: "all" # all|encode|decode
  
  # Codecs to test (comma-separated)
  VIDEO_CODECS: "h264,h265,vp9" # h264,h265,vp9 (VP9 decode only)
  
  # Resolutions to test (comma-separated)
  VIDEO_RESOLUTIONS: "4k" # 4k (3840x2160)
  
  # Encoding duration in seconds
  VIDEO_DURATION: "30" # seconds
  
  # Video framerate
  VIDEO_FRAMERATE: "30" # fps
  
  # Video stack selection
  VIDEO_STACK: "auto" # auto|upstream|downstream
  
  # GStreamer debug level
  VIDEO_GST_DEBUG: "2" # 1-9
  
  # Alternative duration variable (for compatibility)
  RUNTIMESEC: "" # if set, overrides VIDEO_DURATION

run:
  steps:
    - REPO_PATH="$PWD"

    # Navigate to test directory
    - cd Runner/suites/Multimedia/GSTreamer/Video/Video_Encode_Decode/

    # Build CLI args only when params are non-empty
    - |
      CMD="./run.sh"

      [ -n "${VIDEO_TEST_MODE}" ] && CMD="${CMD} --mode ${VIDEO_TEST_MODE}"
      [ -n "${VIDEO_CODECS}" ] && CMD="${CMD} --codecs ${VIDEO_CODECS}"
      [ -n "${VIDEO_RESOLUTIONS}" ] && CMD="${CMD} --resolutions ${VIDEO_RESOLUTIONS}"
      [ -n "${VIDEO_DURATION}" ] && CMD="${CMD} --duration ${VIDEO_DURATION}"
      [ -n "${VIDEO_FRAMERATE}" ] && CMD="${CMD} --framerate ${VIDEO_FRAMERATE}"
      [ -n "${VIDEO_STACK}" ] && CMD="${CMD} --stack ${VIDEO_STACK}"
      [ -n "${VIDEO_GST_DEBUG}" ] && CMD="${CMD} --gst-debug ${VIDEO_GST_DEBUG}"

      echo "[LAVA] Running: ${CMD}"
      sh -c "${CMD}" || true

    # Send result to LAVA
    - "${REPO_PATH}/Runner/utils/send-to-lava.sh Video_Encode_Decode.res || true"
